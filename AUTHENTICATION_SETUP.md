# Authentication & News Service Setup

This document explains how to set up authentication and the market news service in the web version.

## 🔐 Authentication System

The web application now includes a complete authentication system with:
- Email/Password authentication
- Google OAuth
- Protected routes
- User session management

### Setup

1. **Supabase Configuration**
   
   Make sure you have a `.env` file in the `web/` directory with:
   ```env
   VITE_SUPABASE_URL=your_supabase_url_here
   VITE_SUPABASE_PUBLISHABLE_KEY=your_supabase_anon_key_here
   ```

2. **Authentication Flow**
   - Users are redirected to `/auth` if not authenticated
   - After successful login, users are redirected to the dashboard
   - User session is persisted in localStorage
   - Protected routes automatically check authentication status

### Available Features

#### Sign Up
- Email/Password registration
- Email verification (if configured in Supabase)
- Automatic session creation

#### Sign In
- Email/Password login
- Google OAuth (if configured in Supabase)
- "Remember me" functionality (automatic)

#### Sign Out
- Logout from dropdown menu (desktop)
- Logout button in bottom navigation (mobile)

### Files Structure

```
web/src/
├── contexts/
│   └── AuthContext.tsx        # Authentication context and hooks
├── pages/
│   └── Auth.tsx               # Login/Signup page
├── components/
│   └── Navigation.tsx         # Navigation with user menu
└── App.tsx                    # Protected routes configuration
```

## 🤖 AI Market Insights Service

The dashboard now displays AI-powered market analysis for major currency pairs, fetched from Supabase database.

### Configuration

The AI insights are stored in Supabase table `news_and_events`:

```sql
create table public."news and events" (
  id bigint generated by default as identity not null,
  created_at timestamp with time zone not null default now(),
  pair text null,
  content text null,
  constraint "news and events_pkey" primary key (id)
);
```

> **Note**: The table name contains a space and should be referenced as `'news and events'` in queries.

### How it Works

1. **Pair Selection**: Users can select from 8 major currency pairs including Gold
2. **Automatic Fetching**: Insights are fetched from Supabase when pair changes
3. **Auto-Updated Database**: The database is automatically refreshed every hour
4. **Latest Data**: Query retrieves the most recent insight for the selected pair
5. **Formatted Display**: Markdown formatting for better readability

### Available Currency Pairs

- EUR/USD
- GBP/USD
- USD/JPY
- USD/CHF
- AUD/USD
- USD/CAD
- NZD/USD
- XAU/USD (Gold)

### Database Query

The service queries Supabase with:
```typescript
supabase
  .from('news_and_events')
  .select('*')
  .eq('pair', 'EUR/USD')
  .order('created_at', { ascending: false })
  .limit(1)
  .single();
```

### Data Format

The database returns:
```typescript
{
  id: number;
  created_at: string;
  pair: string;
  content: string; // Contains the full analysis report
}
```

The content field contains:
1. **Synthèse Clé**: Overall market sentiment and trends
2. **Événements Économiques**: Upcoming economic events (48h)
3. **Analyse des Nouvelles**: Recent news analysis (24h)
4. **Insight Actionnable**: Trading recommendations

### Features

- **Dynamic Pair Selection**: Dropdown to choose currency pair
- **Markdown Formatting**: Bold text, bullet points, line breaks
- **Loading States**: Shows spinner while fetching
- **Error Handling**: Graceful fallback message on error
- **Scrollable Content**: Up to 600px height with custom scrollbar

## 📰 Market News Service

The dashboard now displays real-time market news from the webhook.

### Configuration

The news webhook is configured in `src/services/newsService.ts`:

```typescript
const NEWS_WEBHOOK_URL = "https://n8n.qubextai.tech/webhook/Rss";
```

### How it Works

1. **Authentication Required**: The news service requires a valid JWT token from Supabase
2. **Automatic Fetching**: News is fetched when the dashboard loads
3. **Auto-Refresh**: News refreshes every 5 minutes
4. **Fallback**: If the service fails, default placeholder news is shown

### News Data Format

The webhook expects to receive an array of news items with this structure:

```typescript
interface NewsItem {
  id: string;
  created_at: string;
  title: string;
  description: string;
  sentiment: "Positive" | "Negative" | "Neutral";
}
```

### API Request

The service makes a POST request to the webhook with:
- **Method**: POST
- **Headers**:
  - `Content-Type: application/json`
- **Body**:
  ```json
  {
    "token": "JWT_TOKEN_FROM_SUPABASE"
  }
  ```

### Features

- **Sentiment Analysis**: News items are color-coded based on sentiment
  - 🟢 Positive: Green indicator
  - 🔴 Negative: Red indicator
  - ⚪ Neutral: Gray indicator
- **Time Formatting**: Relative time display (e.g., "2h ago", "1d ago")
- **Source Extraction**: Automatically extracts news source from description
- **Loading States**: Shows loading spinner while fetching

## 🚀 Usage

### Accessing the Application

1. Start the development server:
   ```bash
   cd web
   npm run dev
   ```

2. Navigate to `http://localhost:5173`

3. You'll be redirected to `/auth` if not authenticated

4. Sign up or sign in with your credentials

5. After authentication, you'll see the dashboard with real-time news

### Dashboard Features

The enhanced dashboard now includes:
- **Portfolio Overview**: Total value and daily changes
- **Quick Stats**: Monthly return, total return, risk score, holdings count
- **Portfolio Holdings**: Detailed view of your positions with allocation
- **Top Performers**: Top gainers and losers
- **AI Insights**: Market insights and recommendations
- **Recent Activity**: Transaction history
- **Market News**: Real-time news with sentiment analysis (NEW ✨)
- **Watchlist**: Monitored stocks

## 🔧 Troubleshooting

### News Not Loading

1. **Check Authentication**: Ensure you're logged in
2. **Check Console**: Look for errors in browser console
3. **Verify Token**: Token is automatically obtained from Supabase session
4. **Check Network**: Verify the webhook URL is accessible

### Authentication Issues

1. **Supabase Configuration**: Verify your `.env` variables
2. **Email Verification**: Check if email confirmation is required
3. **OAuth Setup**: Ensure Google OAuth is configured in Supabase dashboard
4. **Session Persistence**: Clear browser localStorage if having issues

## 🎨 Design Consistency

The authentication and news features maintain the same design system:
- **Colors**: Primary (violet), Success (green), Destructive (red)
- **Glass Cards**: Backdrop blur effects
- **Animations**: Smooth transitions and fade-in effects
- **Responsive**: Mobile-first design with adaptive layouts

## 📱 Mobile vs Web Differences

### Mobile (React Native)
- Uses AsyncStorage for session persistence
- Expo Auth Session for OAuth
- Native navigation

### Web
- Uses localStorage for session persistence
- Standard OAuth redirect flow
- React Router for navigation

Both versions share the same Supabase backend and authentication logic.

