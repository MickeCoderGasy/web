# SQL Setup Guide - AI Market Insights

This guide will help you set up the database table for AI Market Insights in Supabase.

## Step 1: Create the Table

Go to your Supabase Dashboard → SQL Editor and run:

```sql
-- Create the table for AI insights
CREATE TABLE public."news and events" (
  id bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  pair text NULL,
  content text NULL,
  CONSTRAINT "news and events_pkey" PRIMARY KEY (id)
);

-- Add index for better query performance
CREATE INDEX idx_news_and_events_pair ON public."news and events"(pair);
CREATE INDEX idx_news_and_events_created_at ON public."news and events"(created_at DESC);
```

## Step 2: Enable Row Level Security (RLS)

```sql
-- Enable RLS
ALTER TABLE public."news and events" ENABLE ROW LEVEL SECURITY;

-- Create policy to allow authenticated users to read
CREATE POLICY "Allow authenticated users to read insights"
  ON public."news and events"
  FOR SELECT
  TO authenticated
  USING (true);

-- Optional: Create policy to allow service role to insert/update
CREATE POLICY "Allow service role full access"
  ON public."news and events"
  FOR ALL
  TO service_role
  USING (true)
  WITH CHECK (true);
```

## Step 3: Insert Sample Data (Optional for Testing)

```sql
-- Insert sample data for EUR/USD
INSERT INTO public."news and events" (pair, content)
VALUES (
  'EUR/USD',
  '---
**Rapport d''Analyse pour EUR/USD**

**1. Synthèse Clé :**
Le sentiment du marché pour l''EUR/USD est actuellement stable avec une légère tendance haussière. Les données économiques américaines récentes montrent un ralentissement tandis que la zone euro présente des signaux de reprise.

**2. Événements Économiques à Surveiller (Prochaines 48h) :**
*   2025-10-14T16:20:00Z | Discours du Président de la Fed Powell | USD | Haut
*   2025-10-15T12:30:00Z | Indice manufacturier Empire State | USD | Moyen
*   2025-10-16T09:00:00Z | IPC Zone Euro | EUR | Haut

**3. Analyse des Nouvelles Récentes (Dernières 24h) :**
*   **Titre :** EUR/USD maintient sa position au-dessus de 1.10
    **Sentiment :** Positive
    **Résumé :** La paire reste stable malgré les incertitudes économiques mondiales.

**4. Insight Actionnable pour l''Agent de Signal :**
*   **Tendance Générale :** Neutre avec biais légèrement haussier
*   **Facteur Dominant :** Attente des données économiques américaines
*   **Recommandation de Vigilance :** Surveiller le discours de Powell pour volatilité potentielle
---'
);

-- Insert sample data for other pairs
INSERT INTO public."news and events" (pair, content)
VALUES 
  ('GBP/USD', '---\n**Rapport d''Analyse pour GBP/USD**\n\nAnalyse de test pour GBP/USD...\n---'),
  ('USD/JPY', '---\n**Rapport d''Analyse pour USD/JPY**\n\nAnalyse de test pour USD/JPY...\n---'),
  ('XAU/USD', '---\n**Rapport d''Analyse pour XAU/USD (Gold)**\n\nAnalyse de test pour l''or...\n---');
```

## Step 4: Verify the Setup

Check if data was inserted correctly:

```sql
-- View all data
SELECT id, pair, created_at, 
       LEFT(content, 100) as content_preview 
FROM public."news and events" 
ORDER BY created_at DESC;

-- Check available pairs
SELECT DISTINCT pair 
FROM public."news and events" 
ORDER BY pair;

-- Count entries per pair
SELECT pair, COUNT(*) as count 
FROM public."news and events" 
GROUP BY pair 
ORDER BY pair;
```

## Step 5: Test the Query Used by the App

This is the exact query the application uses:

```sql
SELECT * 
FROM public."news and events"
WHERE pair = 'EUR/USD'
ORDER BY created_at DESC
LIMIT 1;
```

## Automated Updates

For production, you should set up an automated process to update this table hourly. Here are some options:

### Option 1: Supabase Edge Function (Recommended)

Create a Supabase Edge Function that runs hourly:

```typescript
// supabase/functions/update-insights/index.ts
import { serve } from "https://deno.land/std@0.168.0/http/server.ts"
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

serve(async (req) => {
  const supabase = createClient(
    Deno.env.get('SUPABASE_URL') ?? '',
    Deno.env.get('SUPABASE_SERVICE_ROLE_KEY') ?? ''
  )

  // Fetch insights from your AI service
  const pairs = ['EUR/USD', 'GBP/USD', 'USD/JPY', 'USD/CHF', 'AUD/USD', 'USD/CAD', 'NZD/USD', 'XAU/USD'];
  
  for (const pair of pairs) {
    // Call your AI analysis webhook/service
    const response = await fetch('https://n8n.qubextai.tech/webhook/AiInsight', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ pair })
    });
    
    const { output } = await response.json();
    
    // Insert into database
    await supabase
      .from('news and events')
      .insert({ pair, content: output });
  }

  return new Response('OK', { status: 200 })
})
```

Then set up a cron job in Supabase Dashboard:
```
0 * * * * (every hour at minute 0)
```

### Option 2: External Cron Job

Use a service like GitHub Actions, Vercel Cron, or a custom server to call your update endpoint hourly.

### Option 3: n8n Workflow (Current Setup)

Your n8n workflow should:
1. Trigger every hour
2. For each currency pair:
   - Generate AI analysis
   - Insert/Update in Supabase table
3. Use Supabase node in n8n or HTTP request

## Maintenance

### Clean Old Data (Optional)

To keep only the latest analysis per pair:

```sql
-- Delete old entries, keeping only the most recent per pair
DELETE FROM public."news and events"
WHERE id NOT IN (
  SELECT DISTINCT ON (pair) id
  FROM public."news and events"
  ORDER BY pair, created_at DESC
);
```

### Monitor Table Size

```sql
-- Check table size
SELECT 
  pg_size_pretty(pg_total_relation_size('"news and events"')) as total_size,
  COUNT(*) as row_count
FROM public."news and events";
```

## Troubleshooting

### Table Not Found Error

If you get "relation does not exist":
1. Make sure the table name is in quotes: `"news and events"`
2. Check it's in the `public` schema
3. Verify in Supabase Dashboard → Table Editor

### Permission Denied

If you get permission errors:
1. Check RLS policies are correct
2. Verify user is authenticated
3. Try with service role key for testing

### No Data Returned

If queries return empty:
1. Run `SELECT * FROM "news and events"` to verify data exists
2. Check the `pair` field matches exactly (case-sensitive)
3. Verify RLS policies allow reading

## Next Steps

Once the table is set up:
1. ✅ Refresh your web application
2. ✅ Try selecting different currency pairs
3. ✅ Check browser console for detailed logs
4. ✅ Set up automated hourly updates
5. ✅ Monitor for errors in production

For more help, see [TROUBLESHOOTING.md](./TROUBLESHOOTING.md)

